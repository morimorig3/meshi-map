# 技術仕様書 (Architecture Design Document)

## テクノロジースタック

### 言語・ランタイム

| 技術       | バージョン | 選定理由                                   |
| ---------- | ---------- | ------------------------------------------ |
| Node.js    | v24.11.0   | LTS版、安定した開発環境                    |
| TypeScript | 5.x        | 静的型付けによる開発効率とコード品質の向上 |
| npm        | 11.x       | Node.js標準搭載、workspacesでモノレポ対応  |

### フロントエンドフレームワーク・ライブラリ

| 技術          | バージョン | 用途                              | 選定理由                                            |
| ------------- | ---------- | --------------------------------- | --------------------------------------------------- |
| Next.js       | 15.x       | Webアプリケーションフレームワーク | React ベース、Cloudflare Pages対応、SSR/SSG対応     |
| React         | 19.x       | UIライブラリ                      | Next.js標準搭載、コンポーネントベース開発           |
| Tailwind CSS  | 4.x        | CSSフレームワーク                 | ユーティリティファースト、高速開発、Next.js公式推奨 |
| React Leaflet | 5.x        | 地図コンポーネント                | Leafletのreactラッパー、無料・オープンソース        |
| Leaflet       | 1.9.x      | 地図ライブラリ                    | 軽量、無料、OpenStreetMapタイル対応                 |

### バックエンドフレームワーク・ライブラリ

| 技術                  | バージョン | 用途                     | 選定理由                                                  |
| --------------------- | ---------- | ------------------------ | --------------------------------------------------------- |
| Hono                  | 4.x        | APIフレームワーク        | 軽量（12KB）、Cloudflare Workers最適化、TypeScript native |
| @supabase/supabase-js | 2.x        | データベースクライアント | Supabase公式クライアント、型安全                          |

### インフラ・外部サービス

| 技術               | 用途                       | 選定理由                                               |
| ------------------ | -------------------------- | ------------------------------------------------------ |
| Cloudflare Pages   | フロントエンドホスティング | 無料枠充実、グローバルCDN、クレカ不要                  |
| Cloudflare Workers | バックエンドホスティング   | 無料枠充実、エッジコンピューティング、低レイテンシ     |
| Supabase           | データベース (PostgreSQL)  | 無料枠あり、認証機能内蔵（将来利用）、自動バックアップ |
| Google Places API  | 店舗検索                   | 日本の飲食店データが豊富、月$200無料クレジット         |
| OpenStreetMap      | 地図タイル                 | 無料、オープンソース、Leaflet標準対応                  |

### 開発ツール

| 技術       | バージョン | 用途               | 選定理由                           |
| ---------- | ---------- | ------------------ | ---------------------------------- |
| ESLint     | 9.x        | 静的解析           | コード品質の担保、チーム開発の統一 |
| Prettier   | 3.x        | コードフォーマット | 一貫したコードスタイル             |
| Vitest     | 2.x        | ユニットテスト     | Vite互換、高速、TypeScript native  |
| Playwright | 1.x        | E2Eテスト          | クロスブラウザ対応、信頼性が高い   |
| Wrangler   | 3.x        | Cloudflare開発CLI  | ローカル開発・デプロイ             |

## アーキテクチャパターン

### 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー（ブラウザ）                        │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│               Cloudflare Pages (フロントエンド)                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    Next.js (React)                        │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────────────┐  │  │
│  │  │ MapScreen  │  │SearchScreen│  │  LocalStorage      │  │  │
│  │  │            │  │            │  │  (匿名ユーザーID)   │  │  │
│  │  └────────────┘  └────────────┘  └────────────────────┘  │  │
│  │         │               │                                 │  │
│  │         └───────────────┴──────────┐                     │  │
│  │                                    ▼                     │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │              API Client (fetch)                   │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│               Cloudflare Workers (バックエンド)                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                     Hono API Server                       │  │
│  │  ┌────────────────┐  ┌────────────────────────────────┐  │  │
│  │  │   API Routes   │  │        Middleware              │  │  │
│  │  │  /api/shops    │  │  - CORS                        │  │  │
│  │  │  /api/regist.  │  │  - Error Handler               │  │  │
│  │  └────────────────┘  │  - Request Validation          │  │  │
│  │         │            └────────────────────────────────┘  │  │
│  │         ▼                                                 │  │
│  │  ┌────────────────────────────────────────────────────┐  │  │
│  │  │                  Service Layer                      │  │  │
│  │  │  ┌──────────────────┐  ┌───────────────────────┐   │  │  │
│  │  │  │ ShopSearchService│  │ RegistrationService   │   │  │  │
│  │  │  └──────────────────┘  └───────────────────────┘   │  │  │
│  │  └────────────────────────────────────────────────────┘  │  │
│  │         │                          │                      │  │
│  │         ▼                          ▼                      │  │
│  │  ┌──────────────┐         ┌───────────────────────────┐  │  │
│  │  │ Google Places│         │    Repository Layer       │  │  │
│  │  │     API      │         │  ┌─────────┐ ┌─────────┐  │  │  │
│  │  └──────────────┘         │  │ShopRepo │ │Regist.  │  │  │  │
│  │                           │  │         │ │Repo     │  │  │  │
│  │                           │  └─────────┘ └─────────┘  │  │  │
│  │                           └───────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Supabase (PostgreSQL)                      │
│  ┌────────────────────┐  ┌────────────────────────────────┐    │
│  │     shops          │  │       registrations            │    │
│  └────────────────────┘  └────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### レイヤードアーキテクチャ（バックエンド）

```
┌─────────────────────────┐
│   APIレイヤー            │ ← リクエスト受付、レスポンス返却
├─────────────────────────┤
│   サービスレイヤー        │ ← ビジネスロジック
├─────────────────────────┤
│   リポジトリレイヤー      │ ← データアクセス抽象化
├─────────────────────────┤
│   データレイヤー          │ ← Supabase/外部API
└─────────────────────────┘
```

#### APIレイヤー

- **責務**: HTTPリクエストの受付、バリデーション、レスポンス返却
- **許可される操作**: サービスレイヤーの呼び出し
- **禁止される操作**: リポジトリレイヤー・データレイヤーへの直接アクセス

#### サービスレイヤー

- **責務**: ビジネスロジックの実装、トランザクション管理
- **許可される操作**: リポジトリレイヤーの呼び出し
- **禁止される操作**: APIレイヤーへの依存、Supabaseクライアントの直接利用

#### リポジトリレイヤー

- **責務**: データアクセスの抽象化、クエリの実行
- **許可される操作**: Supabaseクライアント、外部APIへのアクセス
- **禁止される操作**: ビジネスロジックの実装

## データ永続化戦略

### ストレージ方式

| データ種別     | ストレージ            | フォーマット   | 理由                               |
| -------------- | --------------------- | -------------- | ---------------------------------- |
| 店舗情報       | Supabase PostgreSQL   | リレーショナル | 検索・結合が必要、永続化が必須     |
| 登録情報       | Supabase PostgreSQL   | リレーショナル | ユーザーと店舗の関連付け           |
| 匿名ユーザーID | ブラウザ LocalStorage | 文字列 (UUID)  | サーバー管理不要、プライバシー配慮 |
| 地図キャッシュ | ブラウザキャッシュ    | タイル画像     | Leafletデフォルト動作              |

### バックアップ戦略

**自動バックアップ**:

- **頻度**: Supabaseの自動バックアップで毎日実行（無料プランでも有効）
- **保持期間**: Point-in-Time Recovery（PITR）で7日間
- **保存場所**: Supabase管理下のストレージ

**手動バックアップ**:

- **頻度**: 月次（毎月1日）
- **方法**: Supabaseダッシュボードから手動エクスポート（SQL dump）
- **保存場所**: ローカルストレージ（Gitリポジトリには含めない）

**復旧手順**:

1. Supabaseダッシュボードにログイン
2. 「Database」→「Backups」から復旧ポイントを選択
3. 「Restore」をクリックして復旧実行
4. フロントエンド・バックエンドの動作確認（E2Eテスト実行）
5. 必要に応じてユーザーへ復旧完了を通知

**復旧目標**:

- **RPO（Recovery Point Objective）**: 24時間以内のデータロス許容
- **RTO（Recovery Time Objective）**: 障害検知から2時間以内にサービス復旧

### データ移行（将来のユーザー認証導入時）

```
1. 匿名ユーザーがアカウント作成
2. ローカルストレージの匿名ユーザーIDを取得
3. 匿名ユーザーIDに紐付く登録データを新アカウントに移行
4. ローカルストレージをクリア
```

## パフォーマンス要件

### レスポンスタイム

| 操作              | 目標時間      | 測定条件                                       | 測定方法                                    |
| ----------------- | ------------- | ---------------------------------------------- | ------------------------------------------- |
| 地図初期表示      | 2秒以内       | Chrome 120+、Fast 3G、モバイルシミュレーション | Lighthouse Performance（3回の平均）         |
| 店舗検索結果表示  | 3秒以内       | Chrome DevTools、Fast 3Gスロットリング         | API応答時間 + レンダリング完了（5回の平均） |
| 店舗登録          | 1秒以内       | 本番環境、通常ネットワーク                     | Network タブでAPI応答時間（10回の平均）     |
| マーカー100件表示 | 30fps以上維持 | Chrome 120+、CPU 6x slowdown                   | DevTools Performanceで5秒間の平均FPS        |

**測定環境の標準化**:

- ブラウザ: Chrome 120以上（最新安定版推奨）
- デバイス: モバイルシミュレーション（Moto G Power）
- ネットワーク: Fast 3G（ダウンロード1.6Mbps、アップロード750kbps、RTT 150ms）
- キャッシュ: 初回測定はキャッシュ無効、2回目以降はキャッシュ有効

### リソース使用量

| リソース                      | 上限            | 理由                       |
| ----------------------------- | --------------- | -------------------------- |
| フロントエンド バンドルサイズ | 500KB (gzip)    | 初回読み込み速度の確保     |
| API レスポンスサイズ          | 100KB           | モバイル回線での利用を考慮 |
| Cloudflare Workers CPU時間    | 10ms/リクエスト | 無料枠内での運用           |
| Cloudflare Workers メモリ     | 128MB           | 無料枠の制限               |

### 外部API利用量

| API                | 無料枠               | 想定利用量          | 対策                     |
| ------------------ | -------------------- | ------------------- | ------------------------ |
| Google Places API  | $200/月              | 10,000リクエスト/月 | バックエンドでレート制限 |
| Supabase           | 500MB DB             | 100MB以下           | 店舗データの重複排除     |
| Cloudflare Workers | 100,000リクエスト/日 | 10,000リクエスト/日 | 十分な余裕               |

## セキュリティアーキテクチャ

### データ保護

| 対象                  | 方式                     | 実装方法                             |
| --------------------- | ------------------------ | ------------------------------------ |
| 通信                  | HTTPS                    | Cloudflare自動提供                   |
| Google Places APIキー | 環境変数                 | Cloudflare Workers Secrets           |
| Supabase接続情報      | 環境変数                 | Cloudflare Workers Secrets           |
| データベース          | Row Level Security (RLS) | Supabase設定（将来のユーザー認証時） |

### 入力検証

```typescript
// バリデーションルール
const validationRules = {
  keyword: {
    minLength: 1,
    maxLength: 100,
    pattern: /^[^\x00-\x1f]*$/, // 制御文字禁止
  },
  anonymousUserId: {
    pattern: /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i, // UUID v4
  },
  latitude: {
    min: -90,
    max: 90,
  },
  longitude: {
    min: -180,
    max: 180,
  },
};
```

### セキュリティ対策一覧

| 脅威                | 対策                                               |
| ------------------- | -------------------------------------------------- |
| APIキー露出         | バックエンドでのみ使用、フロントエンドに露出しない |
| SQLインジェクション | Supabaseクライアントのパラメータバインディング     |
| XSS                 | Reactの自動エスケープ、dangerouslySetInnerHTML禁止 |
| CSRF                | SameSite Cookie（将来の認証時）、CORS設定          |
| 不正アクセス        | 匿名ユーザーIDによるデータ分離                     |

## スケーラビリティ設計

### データ増加への対応

**想定データ量（初期3ヶ月）**:

- ユーザー数: 100人（PRDのWAU目標50人の2倍を想定）
- 店舗数: 1,000店舗（ユーザーあたり平均10店舗 × 100人）
- 登録数: 10,000件（上記と同値、重複登録を考慮）

**根拠**: PRDの成功指標「ユーザーあたり平均10店舗登録」「WAU 50人（3ヶ月後）」を基に算出

**パフォーマンス劣化対策**:

- PostgreSQLインデックス: `shops.place_id`, `registrations.anonymous_user_id`
- 地図マーカークラスタリング: 100件以上でクラスタリング表示（将来対応）
- ページネーション: 登録店舗一覧は50件ずつ取得（将来対応）

**スケールアップの閾値**:

| 指標                       | 閾値（80%到達）    | 対策                                   |
| -------------------------- | ------------------ | -------------------------------------- |
| ユーザー数                 | 500人超過          | 有料プランへの移行検討                 |
| 店舗数                     | 5,000店舗超過      | インデックスの追加、クエリ最適化       |
| 登録数                     | 50,000件超過       | ページネーションの実装（1ページ50件）  |
| Supabase DB容量            | 400MB超過          | データ圧縮、古いデータのアーカイブ検討 |
| Cloudflare Workers CPU時間 | 8ms/リクエスト超過 | 処理の最適化、キャッシュ戦略の見直し   |
| Google Places API          | 月間$180到達       | レート制限の強化、キャッシュ導入       |

### 機能拡張性

| 拡張項目         | 対応方針                                       |
| ---------------- | ---------------------------------------------- |
| ユーザー認証     | Supabase Auth導入、匿名データ移行機能          |
| フィルタリング   | API クエリパラメータ追加、フロントエンドUI追加 |
| 画像アップロード | Cloudflare R2（オブジェクトストレージ）導入    |
| モバイルアプリ   | 同一APIを利用、React Native で実装             |

## テスト戦略

### ユニットテスト

- **フレームワーク**: Vitest
- **対象**:
  - サービスレイヤーのビジネスロジック
  - バリデーション関数
  - ユーティリティ関数
- **カバレッジ目標**:
  - 行カバレッジ: 80%以上
  - 分岐カバレッジ: 75%以上
  - 関数カバレッジ: 90%以上
- **モック戦略**:
  - Google Places API: MSW（Mock Service Worker）
  - Supabase: supabase-test-helpers
- **実行タイミング**:
  - ローカル: pre-commit hook（lint-staged経由）
  - CI: プルリクエスト作成時、mainブランチへのpush時

### 統合テスト

- **フレームワーク**: Vitest + Supabase Test Helpers
- **対象**:
  - APIエンドポイントの正常系・異常系
  - データベース操作のCRUD
- **カバレッジ目標**: 全APIエンドポイントの主要パス（正常系・主要異常系）を100%カバー
- **実行タイミング**: CI（プルリクエスト作成時、デプロイ前）

### E2Eテスト

- **フレームワーク**: Playwright
- **シナリオ**:
  - 店舗検索 → 登録 → 地図表示の一連のフロー
  - エラー時のUI表示
  - 初回起動時のオンボーディング表示
  - 登録解除フロー
- **実行タイミング**:
  - ローカル: 手動実行（大きな機能追加時）
  - CI: デプロイ前（ステージング環境で実行）

### テスト実行フロー

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ローカル開発    │ → │   プルリクエスト   │ → │    デプロイ      │
├─────────────────┤    ├─────────────────┤    ├─────────────────┤
│ ユニットテスト    │    │ ユニットテスト    │    │ ユニットテスト    │
│ (pre-commit)    │    │ 統合テスト       │    │ 統合テスト       │
│                 │    │                 │    │ E2Eテスト       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 技術的制約

### 環境要件

**クライアント（ブラウザ）**:

- 対応ブラウザ: Chrome 90+, Firefox 90+, Safari 14+, Edge 90+
- JavaScript有効必須
- LocalStorage利用可能必須
- Geolocation API対応（位置情報取得に必要）

**開発環境**:

- OS: macOS / Linux / Windows (WSL2)
- Node.js: v24.11.0

### Cloudflare Workers 制約

| 制約             | 値                      | 対策                         |
| ---------------- | ----------------------- | ---------------------------- |
| CPU時間          | 10ms/リクエスト（無料） | 軽量な処理に限定             |
| メモリ           | 128MB                   | 大量データの一括処理を避ける |
| リクエストサイズ | 100MB                   | 十分な余裕                   |
| サブリクエスト   | 50/リクエスト           | Google Places APIは1回のみ   |

### Supabase 制約（無料プラン）

| 制約               | 値       | 対策                               |
| ------------------ | -------- | ---------------------------------- |
| データベースサイズ | 500MB    | 店舗データの重複排除               |
| ファイルストレージ | 1GB      | 画像はGoogle Places APIのURLを参照 |
| 同時接続数         | 制限あり | コネクションプーリング             |

## 依存関係管理

### バージョン管理方針

```json
{
  "dependencies": {
    "next": "^15.0.0", // メジャーバージョン固定、マイナー自動
    "react": "^19.0.0", // Next.js互換バージョン
    "hono": "^4.0.0", // メジャーバージョン固定
    "@supabase/supabase-js": "^2.0.0",
    "leaflet": "^1.9.0",
    "react-leaflet": "^5.0.0"
  },
  "devDependencies": {
    "typescript": "~5.3.0", // パッチバージョンのみ自動
    "vitest": "^2.0.0",
    "playwright": "^1.40.0",
    "wrangler": "^3.0.0"
  }
}
```

### 依存関係の更新方針

| 種別               | 更新頻度 | 方法                                            | 担当             | 実行タイミング              |
| ------------------ | -------- | ----------------------------------------------- | ---------------- | --------------------------- |
| セキュリティパッチ | 即座     | `npm audit fix`                                 | 開発者全員       | GitHub Security Alert受信時 |
| パッチバージョン   | 週次     | Dependabot PR自動作成                           | リードエンジニア | 毎週月曜日レビュー          |
| マイナーバージョン | 月次     | `npm outdated`確認後、`npm update`              | リードエンジニア | 毎月第1週                   |
| メジャーバージョン | 随時     | CHANGELOGを確認し、破壊的変更を評価後、手動更新 | チーム全体       | 四半期ごとまたは必要時      |

**運用ルール**:

- セキュリティパッチは全てのPRに優先して適用
- Dependabot PRはCI通過後、24時間以内にレビュー
- メジャーバージョン更新は専用のステアリングファイル（`.steering/YYYYMMDD-upgrade-[package]`）を作成

## 環境構成

### 開発環境

```bash
# ローカル開発
npm run dev           # Next.js開発サーバー (localhost:3000)
npm run dev:api       # Wrangler開発サーバー (localhost:8787)

# 環境変数（.env.local）
NEXT_PUBLIC_API_URL=http://localhost:8787
```

### ステージング環境

- フロントエンド: Cloudflare Pages Preview
- バックエンド: Cloudflare Workers Preview
- データベース: Supabase（開発用プロジェクト）

### 本番環境

- フロントエンド: Cloudflare Pages
- バックエンド: Cloudflare Workers
- データベース: Supabase（本番用プロジェクト）

### 環境変数一覧

| 変数名                | 用途                  | 設定場所                   |
| --------------------- | --------------------- | -------------------------- |
| GOOGLE_PLACES_API_KEY | Google Places API認証 | Cloudflare Workers Secrets |
| SUPABASE_URL          | Supabase接続先        | Cloudflare Workers Secrets |
| SUPABASE_ANON_KEY     | Supabase匿名キー      | Cloudflare Workers Secrets |
| NEXT_PUBLIC_API_URL   | バックエンドAPI URL   | Cloudflare Pages環境変数   |

## CI/CDパイプライン

### ブランチ戦略

| ブランチ             | デプロイ先                                   | トリガー               |
| -------------------- | -------------------------------------------- | ---------------------- |
| `feature/*`          | なし（ローカルのみ）                         | -                      |
| `main`               | 本番環境                                     | push時に自動デプロイ   |
| PR（プルリクエスト） | ステージング環境（Cloudflare Pages Preview） | PR作成時に自動デプロイ |

### デプロイフロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    GitHub Actions ワークフロー                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   [PR作成/更新]                    [main へ push]                │
│        │                               │                        │
│        ▼                               ▼                        │
│   ┌─────────────┐                ┌─────────────┐               │
│   │ Lint & Test │                │ Lint & Test │               │
│   │ (Unit/統合)  │                │ (Unit/統合)  │               │
│   └──────┬──────┘                └──────┬──────┘               │
│          │                              │                       │
│          ▼                              ▼                       │
│   ┌─────────────┐                ┌─────────────┐               │
│   │  Build      │                │  Build      │               │
│   └──────┬──────┘                └──────┬──────┘               │
│          │                              │                       │
│          ▼                              ▼                       │
│   ┌─────────────┐                ┌─────────────┐               │
│   │  Deploy to  │                │  Deploy to  │               │
│   │  Preview    │                │  Production │               │
│   └──────┬──────┘                └──────┬──────┘               │
│          │                              │                       │
│          ▼                              ▼                       │
│   ┌─────────────┐                ┌─────────────┐               │
│   │  E2E Test   │                │  E2E Test   │               │
│   │ (Staging)   │                │ (Production)│               │
│   └─────────────┘                └─────────────┘               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### デプロイ手順（本番）

1. `main`ブランチへのpush（PRマージ）
2. GitHub Actionsトリガー
3. ビルド（`npm run build`）
4. テスト実行（ユニットテスト + 統合テスト）
5. Cloudflare Pagesへのデプロイ（フロントエンド）
6. Cloudflare Workersへのデプロイ（バックエンド）
7. E2Eテスト実行
8. 失敗時は自動ロールバック

### 環境変数管理

| 環境         | 管理方法                            |
| ------------ | ----------------------------------- |
| 開発環境     | `.env.local`（Gitignore対象）       |
| ステージング | Cloudflare Dashboard（Preview環境） |
| 本番環境     | Cloudflare Dashboard（Secrets機能） |
